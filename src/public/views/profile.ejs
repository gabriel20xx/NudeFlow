<%- include("partials/header") %>
<main id="profile-container" class="page-wrapper" aria-label="User profile">
    <h1 class="page-title">Profile</h1>
    <div class="profile-info">
        <img id="profilePicture" src="/images/default-avatar.png" alt="User profile picture">
        <div class="profile-fields">
            <p><strong>Username:</strong> <span id="username">Loading...</span></p>
            <p><strong>Email:</strong> <span id="email">Loading...</span></p>
            <p><strong>Bio:</strong> <span id="bio">Loading...</span></p>
        </div>
    </div>
    <button id="editProfileButton" type="button" class="mt-md">Edit Profile</button>
    <form id="editProfileForm" class="hidden" novalidate>
        <h2 class="page-title" style="font-size:1.1rem;">Edit Profile</h2>
        <label for="usernameInput" class="muted">Username</label>
        <input type="text" id="usernameInput" autocomplete="username" />
        <label for="emailInput" class="muted">Email</label>
        <input type="email" id="emailInput" autocomplete="email" />
        <label for="bioInput" class="muted">Bio</label>
        <textarea id="bioInput" rows="3"></textarea>
        <div style="display:flex;gap:.6rem;flex-wrap:wrap;">
            <button type="button" onclick="saveProfileChanges()">Save</button>
            <button type="button" onclick="cancelEdit()" style="background:linear-gradient(135deg,#5b6775,#404a53);">Cancel</button>
        </div>
    </form>
</main>

    <script>
        async function fetchUserProfile() {
            try {
                const response = await fetch('/api/profile');
                const apiResponse = await response.json();

                if (apiResponse.success && apiResponse.data) {
                    const user = apiResponse.data;
                    document.getElementById('username').textContent = user.username || 'Not set';
                    document.getElementById('email').textContent = user.email || 'Not set';
                    document.getElementById('bio').textContent = user.bio || 'No bio available';
                    document.getElementById('profilePicture').src = user.profilePicture || '/images/default-avatar.png';
                } else {
                    console.error('Failed to fetch profile:', apiResponse.message);
                    document.getElementById('username').textContent = 'Error loading profile';
                }
            } catch (error) {
                console.error('Error fetching profile:', error);
                document.getElementById('username').textContent = 'Error loading profile';
            }
        }

        function editProfile() {
            document.getElementById('editProfileForm').style.display = 'block';
            document.getElementById('usernameInput').value = document.getElementById('username').textContent;
            document.getElementById('emailInput').value = document.getElementById('email').textContent;
            document.getElementById('bioInput').value = document.getElementById('bio').textContent;
        }

        function cancelEdit() {
            document.getElementById('editProfileForm').style.display = 'none';
        }

        async function saveProfileChanges() {
            const updatedProfile = {
                username: document.getElementById('usernameInput').value,
                email: document.getElementById('emailInput').value,
                bio: document.getElementById('bioInput').value,
            };

            const response = await fetch('/api/profile', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updatedProfile),
            });

            if (response.ok) {
                fetchUserProfile();
                cancelEdit();
            } else {
                alert('Error saving profile.');
            }
        }

    document.getElementById('editProfileButton').addEventListener('click', editProfile);
    fetchUserProfile();
    </script>
<%- include("partials/navbar") %>
