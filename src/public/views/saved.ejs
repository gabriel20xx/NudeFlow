<%- include("partials/header") %>
<main id="saved-container" class="page-wrapper" aria-label="Saved media">
    <h1 class="page-title">Saved</h1>
    <p class="muted mt-sm">Your bookmarked media appears here.</p>
    <section id="savedVideos" class="results-grid" aria-live="polite"></section>
    <div id="savedOverlay" class="media-overlay" role="dialog" aria-modal="true" aria-label="Saved media viewer">
        <div class="media-frame" id="savedFrame">
            <button class="close-btn" type="button" aria-label="Close" onclick="closeSavedOverlay()">âœ•</button>
        </div>
    </div>
</main>

    <script>
        const SAVED_STORE_KEY = 'nf_savedMedia_v1';

        function getSavedList(){
            try { const raw = localStorage.getItem(SAVED_STORE_KEY); const arr = raw ? JSON.parse(raw) : []; return Array.isArray(arr)?arr:[]; } catch { return []; }
        }
        function saveSavedList(list){ try { localStorage.setItem(SAVED_STORE_KEY, JSON.stringify(list)); } catch{} }
        function removeSaved(id){ const next = getSavedList().filter(x=>x.id!==id); saveSavedList(next); renderSaved(); }
        function openSavedMedia(item){
            const overlay = document.getElementById('savedOverlay');
            const frame = document.getElementById('savedFrame');
            // remove previous media nodes
            Array.from(frame.querySelectorAll('img,video')).forEach(n=>n.remove());
            let node;
            if(item.mediaType==="static" || /\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(item.url)){
                node = document.createElement('img');
                node.src = item.url;
                node.alt = item.name || 'Saved media';
            } else {
                node = document.createElement('video');
                node.src = item.url;
                node.controls = true;
                node.autoplay = true;
                node.loop = true;
                node.muted = false;
                node.playsInline = true;
            }
            frame.appendChild(node);
            overlay.classList.add('open');
        }
        function closeSavedOverlay(){
            const overlay = document.getElementById('savedOverlay');
            const frame = document.getElementById('savedFrame');
            const vid = frame.querySelector('video');
            if(vid){ try{ vid.pause(); }catch{} }
            overlay.classList.remove('open');
        }

        function renderSaved(){
            const data = getSavedList();
            const container = document.getElementById('savedVideos');
            container.innerHTML = '';
            if(!data.length){ container.innerHTML = '<p>No saved videos yet.</p>'; return; }
            data.forEach(video => {
                const el = document.createElement('div');
                el.className = 'video-item';
                const encoded = encodeURIComponent(JSON.stringify(video));
                el.innerHTML = `
                    <div class="video-thumbnail" role="button" tabindex="0" aria-label="Open ${video.name||'media'}" onclick='openSavedMedia(JSON.parse(decodeURIComponent("${encoded}")))' onkeypress='if(event.key==="Enter"){openSavedMedia(JSON.parse(decodeURIComponent("${encoded}")))}'>
                        <img src="${video.thumbnail || video.url}" alt="${video.name}">
                    </div>
                    <p>${video.name || 'Media'}</p>
                    <small>Category: ${video.category || ''}</small>
                    <div>
                        <button onclick='openSavedMedia(JSON.parse(decodeURIComponent("${encoded}")))'>Open</button>
                        <button onclick="removeSaved('${video.id}')">Remove</button>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        renderSaved();
    </script>
<%- include("partials/navbar") %>
